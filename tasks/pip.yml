---

- name: Update Pip & related tools
  pip:
    name:
      - pip
      - setuptools
      - wheel
      - attrs
      - importlib-metadata
      - packaging
    state: latest
    virtualenv: "{{ virtualenv_path }}"
    virtualenv_python: "{{ openwisp2_wireguard_python }}"
    virtualenv_site_packages: true
    virtualenv_command: "{{ openwisp2_wireguard_virtualenv_command }}"
  retries: 5
  delay: 10
  register: result
  until: result is success
  notify: reload supervisor

- name: Copy Requirements.txt to virtualenv
  copy:
    src: "../requirements.txt"
    dest: "{{ virtualenv_path }}/requirements.txt"
  register: requirements_copy

- name: Install Python dependencies
  pip:
    requirements: "{{ virtualenv_path }}/requirements.txt"
    virtualenv: "{{ virtualenv_path }}"
    virtualenv_python: "{{ openwisp2_wireguard_python }}"
    virtualenv_site_packages: true
    virtualenv_command: "{{ openwisp2_wireguard_virtualenv_command }}"
  notify: reload supervisor
  retries: 5
  delay: 10
  register: result
  until: result is success
  when: requirements_copy is changed
