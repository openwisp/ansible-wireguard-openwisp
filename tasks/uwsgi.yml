---
- name: Create "{{ openwisp2_wireguard_path }}/ssl"
  file:
    path: "{{ openwisp2_wireguard_path }}/ssl"
    state: directory
    mode: 0770
    group: "{{ openwisp_group }}"
  tags: [ssl]

- name: Check if SSL certificate exists
  stat:
    path: "{{ openwisp2_wireguard_ssl_cert }}"
  register: ssl_cert_stat
  tags: [ssl]

- name: Check if SSL certificate has SAN attribute
  become: true
  become_user: root
  shell: |
    set -o pipefail
    openssl x509 -in {{ openwisp2_wireguard_ssl_cert }} -noout -ext subjectAltName 2>/dev/null | grep -q "DNS:"
  args:
    executable: /bin/bash
  register: ssl_cert_san_check
  changed_when: false
  failed_when: false
  when: ssl_cert_stat.stat.exists
  tags: [ssl]

- name: Remove old SSL certificate without SAN attribute
  become: true
  become_user: root
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ openwisp2_wireguard_ssl_cert }}"
    - "{{ openwisp2_wireguard_ssl_key }}"
  when:
    - ssl_cert_stat.stat.exists
    - ssl_cert_san_check.rc != 0
  tags: [ssl]

- name: Create SSL cert with SAN attribute
  become: true
  become_user: root
  command: >
    openssl req -new -nodes -x509 \
    -subj "/C={{ openwisp2_wireguard_ssl_country }}/ST={{ openwisp2_wireguard_ssl_state }} \
           /L={{ openwisp2_wireguard_ssl_locality }}/O={{ openwisp2_wireguard_ssl_organization }} \
           /CN={{ openwisp2_wireguard_ssl_common_name }}" \
    -days 3650 \
    -keyout {{ openwisp2_wireguard_ssl_key }} \
    -out {{ openwisp2_wireguard_ssl_cert }} \
    -addext "subjectAltName = DNS:{{ openwisp2_wireguard_ssl_common_name }},DNS:localhost,IP:127.0.0.1" \
    -extensions v3_ca
  args:
    creates: "{{ openwisp2_wireguard_ssl_cert }}"
  register: ssl_cert_created
  notify: reload supervisor
  tags: [ssl]

- name: Copy self-signed certificate to local CA store
  become: true
  become_user: root
  copy:
    src: "{{ openwisp2_wireguard_ssl_cert }}"
    dest: /usr/local/share/ca-certificates/wireguard_updater_{{ openwisp2_wireguard_vpn_uuid }}.crt
    remote_src: true
    mode: 0644
  register: cert_copied
  tags: [ssl]

- name: Update CA certificates
  become: true
  become_user: root
  command: update-ca-certificates
  when: cert_copied.changed
  tags: [ssl]

- name: Add renewal hook for certbot
  when:
    - openwisp2_wireguard_ssl_cert is defined
    - '"etc/letsencrypt/live/" in openwisp2_wireguard_ssl_cert'
  block:
    - name: Check if certbot is installed
      command: which certbot
      register: certbot_check
      changed_when: false
      failed_when: false
      check_mode: no
    - name: Ensure certbot renewal post hook directory exists
      file:
        path: /etc/letsencrypt/renewal-hooks/post
        state: directory
        owner: root
        group: root
        mode: "0755"
      when:
        - certbot_check.rc == 0
        - certbot_check.stdout != ""
    - name: Create renewal hook to restart uwsgi
      copy:
        dest: /etc/letsencrypt/renewal-hooks/post/restart-openwisp-flask-vpn-updater-{{ openwisp2_wireguard_vpn_uuid }}.sh
        content: |
          #!/bin/bash
          supervisorctl restart openwisp-flask-vpn-updater-{{ openwisp2_wireguard_vpn_uuid }}
        owner: root
        group: root
        mode: "0750"
      when:
        - certbot_check.rc == 0
        - certbot_check.stdout != ""
  tags: [ssl]

- name: uwsgi.ini
  notify: reload supervisor
  template:
    src: flask/uwsgi.ini
    dest: "{{ openwisp2_wireguard_path }}/uwsgi.ini"
    group: "{{ openwisp_group }}"
    mode: 0644
  tags: [flask]
